{"version":3,"file":"tiny-vue.esm.js","sources":["../src/reactivity/src/dep.ts","../src/reactivity/src/effect.ts","../src/reactivity/src/baseHandlers.ts","../src/reactivity/src/reactive.ts"],"sourcesContent":["// 存储所有的 effect 对象\nexport function createDep(effects?) {\n    const dep = new Set(effects)\n    return dep\n}","import { createDep } from \"./dep\";\n\n// 当前的 effect\nlet activeEffect = null;\n// 存储 Map\nconst targetMap = new WeakMap();\n\n// 依赖收集\nexport class ReactiveEffect {\n    constructor(public fn) {}\n\n    run() {\n        // 执行副作用函数\n        // 给全局的 activeEffect 赋值\n        activeEffect = this as any;\n\n        this.fn();\n    }\n}\n\nexport function effect(fn) {\n    const _effect = new ReactiveEffect(fn);\n    _effect.run();\n}\n\n// 追踪依赖\nexport function track(target, type, key) {\n    if (!activeEffect) return\n    /*\n- WeakMap\n    key: object\n    value: map\n        - map\n        key: property\n        value: set\n        - set\n            [effect1、effect2]\n */\n    // 对象-属性-副作用\n    // 根据对象查找相应的属性\n    let depsMap = targetMap.get(target);\n    // 未找到则初始化，并赋值\n    if (!depsMap) {\n        targetMap.set(target, (depsMap = new Map()));\n    }\n    // 根据属性值查找对应的副作用函数\n    let dep = depsMap.get(key);\n    // 未找到则初始化，并赋值\n    if (!dep) {\n        depsMap.set(key, (dep = createDep()));\n    }\n    trackEffects(dep)\n}\n\nfunction trackEffects(dep) {\n    // 用 dep 存放 effect\n    dep.add(activeEffect)\n}\n\n\n// 触发依赖\nexport function trigger(target, type, key) {\n    let deps: Array<any> = []\n\n    const depsMap = targetMap.get(target)\n\n    const dep = depsMap.get(key)\n\n    deps.push(dep)\n\n    const effects: Array<any> = []\n    deps.forEach(dep => {\n        // 解构 dep 得到的是 dep 内部存储的 effect\n        effects.push(...dep)\n    })\n    triggerEffects(createDep(effects))\n}\n\nfunction triggerEffects(dep) {\n    for (const effect of dep) {\n        effect.run()\n    }\n}","import { track, trigger } from \"./effect\";\nimport {ReactiveFlags} from './reactive'\nconst get = createGetter();\nconst set = createSetter();\n\nfunction createGetter(isReadonly = false, shallow = false) {\n    return function get(target, key, receiver) {\n        console.log('Proxy get 函数触发了. target:', (target), 'key: ', key);\n        // 判断 reactive 类型\n        if (key == ReactiveFlags.IS_REACTIVE) {\n            return true\n        }\n        // 反射\n        const res = Reflect.get(target, key, receiver);\n        // 注入追踪依赖\n        track(target, \"get\", key);\n        // 返回值\n        return res;\n    };\n}\n\nfunction createSetter() {\n    return function set(target, key, value, receiver) {\n        console.log('Proxy set 函数触发了. target:', (target), ' key: ', key, ' value: ', value);\n        // 反射\n        const res = Reflect.set(target, key, value, receiver);\n        // 注入执行依赖\n        trigger(target, \"get\", key);\n        // 返回值\n        return res;\n    };\n}\n\nexport const mutableHandlers = {\n    get,\n    set,\n};\n","// Vue3.x 的 reactivity 就是基于 Proxy 来实现的\n// 通过监听 get 和 set\n// 在 get 中收集副作用函数\n// 在 set 中执行副作用函数\nimport { mutableHandlers } from \"./baseHandlers\";\n\nexport const enum ReactiveFlags {\n    IS_REACTIVE = '__v_isReactive'\n}\n\nexport function reactive(target) {\n    return createReactiveObject(target);\n}\n\nexport function isReactive(value) {\n    // value 是 proxy, 会触发 get 操作\n    // value 是 普通对象的话 会返回 undefined，转成布尔值\n    return !!value[ReactiveFlags.IS_REACTIVE]\n}\n\nfunction createReactiveObject(target) {\n    return new Proxy(target, mutableHandlers);\n}\n\n\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACM,SAAU,SAAS,CAAC,OAAQ,EAAA;AAC9B,IAAA,IAAM,GAAG,GAAG,IAAI,GAAG,CAAC,OAAO,CAAC,CAAA;AAC5B,IAAA,OAAO,GAAG,CAAA;AACd;;ACDA,IAAI,YAAY,GAAG,IAAI,CAAC;AAExB,IAAM,SAAS,GAAG,IAAI,OAAO,EAAE,CAAC;AAGhC,IAAA,cAAA,IAAA,YAAA;AACI,IAAA,SAAA,cAAA,CAAmB,EAAE,EAAA;QAAF,IAAE,CAAA,EAAA,GAAF,EAAE,CAAA;KAAI;AAEzB,IAAA,cAAA,CAAA,SAAA,CAAA,GAAG,GAAH,YAAA;QAGI,YAAY,GAAG,IAAW,CAAC;QAE3B,IAAI,CAAC,EAAE,EAAE,CAAC;KACb,CAAA;IACL,OAAC,cAAA,CAAA;AAAD,CAAC,EAAA,CAAA,CAAA;AAEK,SAAU,MAAM,CAAC,EAAE,EAAA;AACrB,IAAA,IAAM,OAAO,GAAG,IAAI,cAAc,CAAC,EAAE,CAAC,CAAC;IACvC,OAAO,CAAC,GAAG,EAAE,CAAC;AAClB,CAAC;SAGe,KAAK,CAAC,MAAM,EAAE,IAAI,EAAE,GAAG,EAAA;AACnC,IAAA,IAAI,CAAC,YAAY;QAAE,OAAM;IAazB,IAAI,OAAO,GAAG,SAAS,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;IAEpC,IAAI,CAAC,OAAO,EAAE;AACV,QAAA,SAAS,CAAC,GAAG,CAAC,MAAM,GAAG,OAAO,GAAG,IAAI,GAAG,EAAE,EAAE,CAAC;AAChD,KAAA;IAED,IAAI,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;IAE3B,IAAI,CAAC,GAAG,EAAE;AACN,QAAA,OAAO,CAAC,GAAG,CAAC,GAAG,GAAG,GAAG,GAAG,SAAS,EAAE,EAAE,CAAC;AACzC,KAAA;IACD,YAAY,CAAC,GAAG,CAAC,CAAA;AACrB,CAAC;AAED,SAAS,YAAY,CAAC,GAAG,EAAA;AAErB,IAAA,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC,CAAA;AACzB,CAAC;SAIe,OAAO,CAAC,MAAM,EAAE,IAAI,EAAE,GAAG,EAAA;IACrC,IAAI,IAAI,GAAe,EAAE,CAAA;IAEzB,IAAM,OAAO,GAAG,SAAS,CAAC,GAAG,CAAC,MAAM,CAAC,CAAA;IAErC,IAAM,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAA;AAE5B,IAAA,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;IAEd,IAAM,OAAO,GAAe,EAAE,CAAA;AAC9B,IAAA,IAAI,CAAC,OAAO,CAAC,UAAA,GAAG,EAAA;AAEZ,QAAA,OAAO,CAAC,IAAI,CAAA,KAAA,CAAZ,OAAO,EAAA,aAAA,CAAA,EAAA,EAAA,MAAA,CAAS,GAAG,CAAC,EAAA,KAAA,CAAA,CAAA,CAAA;AACxB,KAAC,CAAC,CAAA;AACF,IAAA,cAAc,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAA;AACtC,CAAC;AAED,SAAS,cAAc,CAAC,GAAG,EAAA;;;AACvB,QAAA,KAAqB,IAAA,KAAA,GAAA,QAAA,CAAA,GAAG,CAAA,wBAAA,EAAE,CAAA,OAAA,CAAA,IAAA,EAAA,OAAA,GAAA,KAAA,CAAA,IAAA,EAAA,EAAA;AAArB,YAAA,IAAM,QAAM,GAAA,OAAA,CAAA,KAAA,CAAA;YACb,QAAM,CAAC,GAAG,EAAE,CAAA;AACf,SAAA;;;;;;;;;AACL;;AChFA,IAAM,GAAG,GAAG,YAAY,EAAE,CAAC;AAC3B,IAAM,GAAG,GAAG,YAAY,EAAE,CAAC;AAE3B,SAAS,YAAY,CAAC,UAAkB,EAAE,OAAe,EAAA;AACrD,IAAA,OAAO,SAAS,GAAG,CAAC,MAAM,EAAE,GAAG,EAAE,QAAQ,EAAA;AACrC,QAAA,OAAO,CAAC,GAAG,CAAC,0BAA0B,GAAG,MAAM,GAAG,OAAO,EAAE,GAAG,CAAC,CAAC;QAEhE,IAAI,GAAG,oBAA6B,EAAE;AAClC,YAAA,OAAO,IAAI,CAAA;AACd,SAAA;AAED,QAAA,IAAM,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,GAAG,EAAE,QAAQ,CAAC,CAAC;AAE/C,QAAA,KAAK,CAAC,MAAM,EAAE,KAAK,EAAE,GAAG,CAAC,CAAC;AAE1B,QAAA,OAAO,GAAG,CAAC;AACf,KAAC,CAAC;AACN,CAAC;AAED,SAAS,YAAY,GAAA;IACjB,OAAO,SAAS,GAAG,CAAC,MAAM,EAAE,GAAG,EAAE,KAAK,EAAE,QAAQ,EAAA;AAC5C,QAAA,OAAO,CAAC,GAAG,CAAC,0BAA0B,GAAG,MAAM,GAAG,QAAQ,EAAE,GAAG,EAAE,UAAU,EAAE,KAAK,CAAC,CAAC;AAEpF,QAAA,IAAM,GAAG,GAAG,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,GAAG,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC;AAEtD,QAAA,OAAO,CAAC,MAAM,EAAE,KAAK,EAAE,GAAG,CAAC,CAAC;AAE5B,QAAA,OAAO,GAAG,CAAC;AACf,KAAC,CAAC;AACN,CAAC;AAEM,IAAM,eAAe,GAAG;AAC3B,IAAA,GAAG,EAAA,GAAA;AACH,IAAA,GAAG,EAAA,GAAA;CACN;;AC1BK,SAAU,QAAQ,CAAC,MAAM,EAAA;AAC3B,IAAA,OAAO,oBAAoB,CAAC,MAAM,CAAC,CAAC;AACxC,CAAC;AAEK,SAAU,UAAU,CAAC,KAAK,EAAA;AAG5B,IAAA,OAAO,CAAC,CAAC,KAAK,CAAA,gBAAA,CAA2B,CAAA;AAC7C,CAAC;AAED,SAAS,oBAAoB,CAAC,MAAM,EAAA;AAChC,IAAA,OAAO,IAAI,KAAK,CAAC,MAAM,EAAE,eAAe,CAAC,CAAC;AAC9C;;;;"}